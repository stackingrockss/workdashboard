// Prisma schema for Opportunity Tracker
// Last updated: 2025-10-11

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["opportunity_tracker"]
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  name          String
  avatarUrl     String?
  opportunities Opportunity[]
  kanbanColumns KanbanColumn[]
  createdAt     DateTime       @default(now())

  @@schema("opportunity_tracker")
}

enum OpportunityStage {
  prospect
  qualification
  proposal
  negotiation
  closedWon
  closedLost

  @@schema("opportunity_tracker")
}

enum ForecastCategory {
  pipeline
  bestCase
  forecast

  @@schema("opportunity_tracker")
}

enum ContactRole {
  decision_maker
  influencer
  champion
  blocker
  end_user

  @@schema("opportunity_tracker")
}

enum ContactSentiment {
  advocate
  positive
  neutral
  negative
  unknown

  @@schema("opportunity_tracker")
}

model Account {
  id            String         @id @default(cuid())
  name          String         @unique
  industry      String?
  priority      String         @default("medium") // low, medium, high
  health        String         @default("good") // good, at-risk, critical
  notes         String?
  opportunities Opportunity[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@schema("opportunity_tracker")
}

model KanbanColumn {
  id        String   @id @default(cuid())
  title     String
  order     Int
  color     String?  // Optional hex color for the column header
  userId    String?  // Optional: per-user columns, null for global columns
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, order])
  @@schema("opportunity_tracker")
}

model Opportunity {
  id               String             @id @default(cuid())
  name             String
  // Keep old account field for backward compatibility during migration
  accountName      String?
  // New relation to Account model
  accountId        String?
  account          Account?           @relation(fields: [accountId], references: [id])
  amountArr        Int
  probability      Int
  nextStep         String?
  closeDate        DateTime?
  quarter          String?            // e.g., "Q1 2025", "Q2 2025"
  stage            OpportunityStage
  // New flexible column assignment
  columnId         String?            // References KanbanColumn.id
  forecastCategory ForecastCategory?
  riskNotes        String?
  notes            String?
  ownerId          String
  owner            User               @relation(fields: [ownerId], references: [id])
  granolaNotes     GranolaNote[]
  contacts         Contact[]
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  @@schema("opportunity_tracker")
}

model GranolaNote {
  id            String       @id @default(cuid())
  opportunityId String
  opportunity   Opportunity  @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  title         String
  url           String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@schema("opportunity_tracker")
}

model Contact {
  id              String            @id @default(cuid())
  firstName       String
  lastName        String
  title           String?           // Job title (e.g., "VP of Engineering")
  email           String?
  phone           String?
  role            ContactRole       // Decision maker, influencer, etc.
  sentiment       ContactSentiment  @default(unknown) // How they feel about the deal
  opportunityId   String
  opportunity     Opportunity       @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  managerId       String?           // Self-referencing for org hierarchy
  manager         Contact?          @relation("ContactReports", fields: [managerId], references: [id], onDelete: SetNull)
  directReports   Contact[]         @relation("ContactReports")
  positionX       Float?            // X coordinate for org chart positioning
  positionY       Float?            // Y coordinate for org chart positioning
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@schema("opportunity_tracker")
}


