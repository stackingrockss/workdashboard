generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["opportunity_tracker"]
}

model Account {
  id             String          @id @default(cuid())
  name           String
  industry       String?
  priority       String          @default("medium")
  health         String          @default("good")
  notes          String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  ownerId        String?
  organizationId String
  website        String?
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner          User?           @relation("AccountOwner", fields: [ownerId], references: [id])
  calendarEvents CalendarEvent[]
  contacts       Contact[]
  opportunities  Opportunity[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([ownerId])
  @@schema("opportunity_tracker")
}

model Contact {
  id            String           @id @default(cuid())
  firstName     String
  lastName      String
  title         String?
  email         String?
  phone         String?
  role          ContactRole
  sentiment     ContactSentiment @default(unknown)
  opportunityId String?
  managerId     String?
  positionX     Float?
  positionY     Float?
  notes         String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  accountId     String?
  account       Account?         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  manager       Contact?         @relation("ContactReports", fields: [managerId], references: [id])
  directReports Contact[]        @relation("ContactReports")
  opportunity   Opportunity?     @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([accountId])
  @@schema("opportunity_tracker")
}

model GongCall {
  id             String         @id @default(cuid())
  opportunityId  String
  title          String
  url            String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  meetingDate    DateTime
  noteType       NoteType?      @default(customer)
  goals          Json?
  nextSteps      Json?
  painPoints     Json?
  parsedAt       DateTime?
  parsedPeople   Json?
  transcriptText String?
  parsingError   String?
  parsingStatus  ParsingStatus?
  riskAssessment Json?
  opportunity    Opportunity    @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([parsingStatus])
  @@schema("opportunity_tracker")
}

model GoogleNote {
  id            String      @id @default(cuid())
  opportunityId String
  title         String
  url           String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@schema("opportunity_tracker")
}

model GranolaNote {
  id            String      @id @default(cuid())
  opportunityId String
  title         String
  url           String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  meetingDate   DateTime
  noteType      NoteType?   @default(customer)
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@schema("opportunity_tracker")
}

model Invitation {
  id             String       @id @default(cuid())
  email          String
  role           UserRole     @default(REP)
  organizationId String
  invitedById    String
  token          String       @unique @default(cuid())
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime     @default(now())
  invitedBy      User         @relation(fields: [invitedById], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@schema("opportunity_tracker")
}

model KanbanColumn {
  id        String     @id @default(cuid())
  title     String
  order     Int
  color     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  viewId    String
  view      KanbanView @relation(fields: [viewId], references: [id], onDelete: Cascade)

  @@unique([viewId, order])
  @@schema("opportunity_tracker")
}

model KanbanView {
  id             String         @id @default(cuid())
  name           String
  viewType       ViewType
  isActive       Boolean        @default(false)
  isDefault      Boolean        @default(false)
  userId         String?
  organizationId String?
  lastAccessedAt DateTime?
  isShared       Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  columns        KanbanColumn[]
  organization   Organization?  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@unique([organizationId, name])
  @@index([userId, isActive])
  @@index([organizationId, isActive])
  @@schema("opportunity_tracker")
}

model Opportunity {
  id                         String                 @id @default(cuid())
  name                       String
  amountArr                  Int
  nextStep                   String?
  closeDate                  DateTime?
  stage                      OpportunityStage
  ownerId                    String
  createdAt                  DateTime               @default(now())
  updatedAt                  DateTime               @updatedAt
  accountId                  String?
  accountName                String?
  quarter                    String?
  forecastCategory           ForecastCategory?
  notes                      String?
  riskNotes                  String?
  columnId                   String?
  accountResearch            String?
  confidenceLevel            Int                    @default(3)
  decisionMakers             String?
  competition                String?
  legalReviewStatus          ReviewStatus?          @default(not_started)
  securityReviewStatus       ReviewStatus?          @default(not_started)
  platformType               PlatformType?
  businessCaseStatus         ReviewStatus?          @default(not_started)
  organizationId             String
  pinnedToWhiteboard         Boolean                @default(false)
  accountResearchStatus      AccountResearchStatus?
  accountResearchGeneratedAt DateTime?
  goalsHistory               String?
  nextStepsHistory           String?
  painPointsHistory          String?
  parsedGongCallIds          String[]               @default([])
  consolidatedGoals          Json?
  consolidatedPainPoints     Json?
  consolidatedRiskAssessment Json?
  consolidationCallCount     Int?
  lastConsolidatedAt         DateTime?
  cbc                        String?
  calendarEvents             CalendarEvent[]
  contacts                   Contact[]
  gongCalls                  GongCall[]
  googleNotes                GoogleNote[]
  granolaNotes               GranolaNote[]
  account                    Account?               @relation(fields: [accountId], references: [id])
  organization               Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner                      User                   @relation(fields: [ownerId], references: [id])

  @@index([organizationId])
  @@index([ownerId])
  @@index([accountId])
  @@index([columnId])
  @@index([closeDate])
  @@index([pinnedToWhiteboard])
  @@schema("opportunity_tracker")
}

model Organization {
  id                   String                @id @default(cuid())
  name                 String
  domain               String?               @unique
  logo                 String?
  fiscalYearStartMonth Int                   @default(1)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  accounts             Account[]
  invitations          Invitation[]
  kanbanViews          KanbanView[]
  opportunities        Opportunity[]
  settings             OrganizationSettings?
  users                User[]

  @@schema("opportunity_tracker")
}

model OrganizationSettings {
  id                      String       @id @default(cuid())
  organizationId          String       @unique
  defaultKanbanView       String?
  defaultKanbanTemplateId String?
  allowSelfSignup         Boolean      @default(false)
  allowDomainAutoJoin     Boolean      @default(false)
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt
  organization            Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@schema("opportunity_tracker")
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  name           String?
  avatarUrl      String?
  createdAt      DateTime        @default(now())
  supabaseId     String?         @unique
  managerId      String?
  organizationId String?
  role           UserRole        @default(REP)
  ownedAccounts  Account[]       @relation("AccountOwner")
  calendarEvents CalendarEvent[]
  invitations    Invitation[]
  kanbanViews    KanbanView[]
  oauthTokens    OAuthToken[]
  opportunities  Opportunity[]
  manager        User?           @relation("ManagerReps", fields: [managerId], references: [id])
  directReports  User[]          @relation("ManagerReps")
  organization   Organization?   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([managerId])
  @@schema("opportunity_tracker")
}

model OAuthToken {
  id           String   @id @default(cuid())
  userId       String
  provider     String
  accessToken  String
  refreshToken String?
  expiresAt    DateTime
  scopes       String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@index([expiresAt])
  @@schema("opportunity_tracker")
}

model CalendarEvent {
  id             String       @id @default(cuid())
  userId         String
  googleEventId  String
  summary        String
  description    String?
  location       String?
  startTime      DateTime
  endTime        DateTime
  attendees      String[]
  isExternal     Boolean
  organizerEmail String?
  meetingUrl     String?
  opportunityId  String?
  accountId      String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  account        Account?     @relation(fields: [accountId], references: [id])
  opportunity    Opportunity? @relation(fields: [opportunityId], references: [id])
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, googleEventId])
  @@index([userId, startTime])
  @@index([opportunityId])
  @@index([accountId])
  @@schema("opportunity_tracker")
}

enum ContactRole {
  decision_maker
  influencer
  champion
  blocker
  end_user

  @@schema("opportunity_tracker")
}

enum ContactSentiment {
  advocate
  positive
  neutral
  negative
  unknown

  @@schema("opportunity_tracker")
}

enum ForecastCategory {
  pipeline
  bestCase
  forecast

  @@schema("opportunity_tracker")
}

enum NoteType {
  customer
  internal
  prospect

  @@schema("opportunity_tracker")
}

enum OpportunityStage {
  discovery
  demo
  validateSolution
  decisionMakerApproval
  contracting
  closedWon
  closedLost

  @@schema("opportunity_tracker")
}

enum PlatformType {
  oem
  api
  isv

  @@schema("opportunity_tracker")
}

enum ReviewStatus {
  not_started
  in_progress
  complete
  not_applicable

  @@schema("opportunity_tracker")
}

enum UserRole {
  ADMIN
  MANAGER
  REP
  VIEWER

  @@schema("opportunity_tracker")
}

enum ViewType {
  custom
  quarterly
  stages
  forecast

  @@schema("opportunity_tracker")
}

enum AccountResearchStatus {
  generating
  completed
  failed

  @@schema("opportunity_tracker")
}

enum ParsingStatus {
  pending
  parsing
  completed
  failed

  @@schema("opportunity_tracker")
}
