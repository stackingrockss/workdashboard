generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["opportunity_tracker"]
}

model Account {
  id                  String                   @id @default(cuid())
  name                String
  industry            String?
  priority            String                   @default("medium")
  health              String                   @default("good")
  notes               String?
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  ownerId             String?
  organizationId      String
  website             String?
  ticker              String?
  nextEarningsDate    DateTime?
  earningsDateSource  String?
  lastEarningsSync    DateTime?
  organization        Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner               User?                    @relation("AccountOwner", fields: [ownerId], references: [id])
  calendarEvents      CalendarEvent[]
  chatMessages        ChatMessage[]
  contacts            Contact[]
  earningsTranscripts EarningsCallTranscript[]
  opportunities       Opportunity[]
  secFilings          SecFiling[]
  tasks               Task[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([ownerId])
  @@index([nextEarningsDate])
  @@schema("opportunity_tracker")
}

model Contact {
  id            String           @id @default(cuid())
  firstName     String
  lastName      String
  title         String?
  email         String?
  phone         String?
  role          ContactRole
  sentiment     ContactSentiment @default(unknown)
  opportunityId String?
  managerId     String?
  positionX     Float?
  positionY     Float?
  notes         String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  accountId     String?
  account       Account?         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  manager       Contact?         @relation("ContactReports", fields: [managerId], references: [id])
  directReports Contact[]        @relation("ContactReports")
  opportunity   Opportunity?     @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([accountId])
  @@index([opportunityId, role])
  @@index([accountId, role])
  @@schema("opportunity_tracker")
}

model GongCall {
  id                         String                      @id @default(cuid())
  opportunityId              String?                     // Optional for unlinked calls from Gong sync
  organizationId             String                      // Required for multi-tenancy (unlinked calls)
  title                      String
  url                        String
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  meetingDate                DateTime
  noteType                   NoteType?                   @default(customer)
  goals                      Json?
  nextSteps                  Json?
  painPoints                 Json?
  parsedAt                   DateTime?
  parsedPeople               Json?
  transcriptText             String?
  parsingError               String?
  parsingStatus              ParsingStatus?
  riskAssessment             Json?
  whyAndWhyNow               Json?                       // Array of business driver/urgency reasons: string[]
  quantifiableMetrics        Json?                       // Array of ROI/measurable outcomes: string[]
  calendarEventId            String?

  // Gong API sync fields
  gongCallId                 String?                     @unique // External Gong call ID for deduplication
  gongUrl                    String?                     // Direct link to call in Gong app
  duration                   Int?                        // Call duration in seconds
  direction                  String?                     // 'Inbound' | 'Outbound' | 'Conference'
  participants               Json?                       // Array of participant details from Gong
  primaryParticipantEmail    String?                     // Main external participant email for matching
  syncedAt                   DateTime?                   // When this call was synced from Gong
  syncSource                 String?                     // 'manual' | 'auto'

  calendarEvent                CalendarEvent?              @relation(fields: [calendarEventId], references: [id], onDelete: SetNull)
  contactsReadyNotifications   ContactsReadyNotification[]
  parsingCompleteNotifications ParsingCompleteNotification[] @relation("GongCallParsingCompleteNotifications")
  opportunity                  Opportunity?                @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  organization                 Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([organizationId])
  @@index([parsingStatus])
  @@index([calendarEventId])
  @@index([opportunityId, meetingDate])
  @@index([opportunityId, parsingStatus])
  @@index([organizationId, syncedAt])
  @@index([gongCallId])
  @@schema("opportunity_tracker")
}

model GoogleNote {
  id            String      @id @default(cuid())
  opportunityId String
  title         String
  url           String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@schema("opportunity_tracker")
}

model GranolaNote {
  id                         String                      @id @default(cuid())
  opportunityId              String
  title                      String
  url                        String
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  meetingDate                DateTime
  noteType                   NoteType?                   @default(customer)
  calendarEventId            String?
  transcriptText             String?
  goals                      Json?
  nextSteps                  Json?
  painPoints                 Json?
  parsedAt                   DateTime?
  parsedPeople               Json?
  parsingError               String?
  parsingStatus              ParsingStatus?
  riskAssessment             Json?
  whyAndWhyNow               Json?                       // Array of business driver/urgency reasons: string[]
  quantifiableMetrics        Json?                       // Array of ROI/measurable outcomes: string[]
  calendarEvent                CalendarEvent?              @relation(fields: [calendarEventId], references: [id], onDelete: SetNull)
  contactsReadyNotifications   ContactsReadyNotification[]
  parsingCompleteNotifications ParsingCompleteNotification[] @relation("GranolaParsingCompleteNotifications")
  opportunity                  Opportunity                 @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([calendarEventId])
  @@index([parsingStatus])
  @@schema("opportunity_tracker")
}

model Invitation {
  id             String       @id @default(cuid())
  email          String
  role           UserRole     @default(REP)
  organizationId String
  invitedById    String
  token          String       @unique @default(cuid())
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime     @default(now())
  invitedBy      User         @relation(fields: [invitedById], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@schema("opportunity_tracker")
}

model KanbanColumn {
  id        String     @id @default(cuid())
  title     String
  order     Int
  color     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  viewId    String
  view      KanbanView @relation(fields: [viewId], references: [id], onDelete: Cascade)

  @@unique([viewId, order])
  @@schema("opportunity_tracker")
}

model KanbanView {
  id             String         @id @default(cuid())
  name           String
  viewType       ViewType
  isActive       Boolean        @default(false)
  isDefault      Boolean        @default(false)
  userId         String?
  organizationId String?
  lastAccessedAt DateTime?
  isShared       Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  columns        KanbanColumn[]
  organization   Organization?  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@unique([organizationId, name])
  @@index([userId, isActive])
  @@index([organizationId, isActive])
  @@schema("opportunity_tracker")
}

model Opportunity {
  id                         String                   @id @default(cuid())
  name                       String
  amountArr                  Int
  nextStep                   String?
  closeDate                  DateTime?
  stage                      OpportunityStage
  ownerId                    String
  createdAt                  DateTime                 @default(now())
  updatedAt                  DateTime                 @updatedAt
  accountId                  String?
  accountName                String?
  domain                     String?                  // Domain for calendar event matching (e.g., "premera.com")
  quarter                    String?
  forecastCategory           ForecastCategory?
  notes                      String?                  @db.Text
  riskNotes                  String?
  columnId                   String?
  accountResearch            String?
  confidenceLevel            Int                      @default(3)
  decisionMakers             String?
  competition                String?
  legalReviewStatus          ReviewStatus?            @default(not_started)
  securityReviewStatus       ReviewStatus?            @default(not_started)
  platformType               PlatformType?
  businessCaseStatus         ReviewStatus?            @default(not_started)
  organizationId             String
  pinnedToWhiteboard         Boolean                  @default(false)
  accountResearchStatus      AccountResearchStatus?
  accountResearchGeneratedAt DateTime?
  goalsHistory               String?
  nextStepsHistory           String?
  painPointsHistory          String?
  parsedGongCallIds          String[]                 @default([])
  parsedGranolaIds           String[]                 @default([])
  consolidatedGoals          Json?
  consolidatedPainPoints     Json?
  consolidatedRiskAssessment Json?
  riskAssessmentHistory      String?
  whyAndWhyNowHistory        String?                      // Per-call history (append-only, date-prefixed)
  quantifiableMetricsHistory String?                      // Per-call history (append-only, date-prefixed)
  consolidatedWhyAndWhyNow   Json?                        // Consolidated array of business drivers: string[]
  consolidatedMetrics        Json?                        // Consolidated array of ROI metrics: string[]
  consolidationCallCount     Int?
  lastConsolidatedAt         DateTime?
  consolidationStatus        ConsolidationStatus?     @default(idle)
  businessCaseContent        String?                  @db.Text
  businessCaseQuestions      String?                  @db.Text
  businessCaseGeneratedAt    DateTime?
  businessCaseGenerationStatus String?
  // Business Impact Proposal fields
  businessProposalContent         String?             @db.Text
  businessProposalGeneratedAt     DateTime?
  businessProposalGenerationStatus String?            // 'generating' | 'completed' | 'failed'
  cbc                        DateTime?
  nextCallDate               DateTime?
  nextCallDateSource         NextCallDateSource?
  nextCallDateManuallySet    Boolean                  @default(false)
  nextCallDateLastCalculated DateTime?
  nextCallDateEventId        String?
  calendarEvents               CalendarEvent[]
  chatMessages                 ChatMessage[]
  contacts                     Contact[]
  contactsReadyNotifications     ContactsReadyNotification[]
  parsingCompleteNotifications   ParsingCompleteNotification[]   @relation("OpportunityParsingCompleteNotifications")
  accountResearchNotification    AccountResearchNotification?    @relation("OpportunityAccountResearchNotification")
  earningsTranscripts            EarningsCallTranscript[]
  documents                      Document[]
  generatedContents              GeneratedContent[]
  gongCalls                  GongCall[]
  googleNotes                GoogleNote[]
  granolaNotes               GranolaNote[]
  mutualActionPlan           MutualActionPlan?
  account                    Account?                 @relation(fields: [accountId], references: [id])
  organization               Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner                      User                     @relation(fields: [ownerId], references: [id])
  tasks                      Task[]

  @@index([organizationId])
  @@index([ownerId])
  @@index([accountId])
  @@index([columnId])
  @@index([closeDate])
  @@index([pinnedToWhiteboard])
  @@index([nextCallDate])
  @@index([organizationId, nextCallDate])
  @@schema("opportunity_tracker")
}

model Organization {
  id                         String                      @id @default(cuid())
  name                       String
  domain                     String?                     @unique
  logo                       String?
  fiscalYearStartMonth       Int                         @default(1)
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  accounts                   Account[]
  comments                     Comment[]
  commentMentions              CommentMention[]
  contactsReadyNotifications     ContactsReadyNotification[]
  parsingCompleteNotifications   ParsingCompleteNotification[]
  accountResearchNotifications   AccountResearchNotification[]
  contents                       Content[]
  contentFrameworks              ContentFramework[]
  documents                      Document[]
  generatedContents              GeneratedContent[]
  earningsTranscripts        EarningsCallTranscript[]
  gongCalls                  GongCall[]
  gongIntegration            GongIntegration?
  invitations                Invitation[]
  kanbanViews                KanbanView[]
  mutualActionPlans          MutualActionPlan[]
  opportunities              Opportunity[]
  settings                   OrganizationSettings?
  secFilings                 SecFiling[]
  users                      User[]

  @@schema("opportunity_tracker")
}

model OrganizationSettings {
  id                      String       @id @default(cuid())
  organizationId          String       @unique
  defaultKanbanView       String?
  defaultKanbanTemplateId String?
  allowSelfSignup         Boolean      @default(false)
  allowDomainAutoJoin     Boolean      @default(false)
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt
  organization            Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@schema("opportunity_tracker")
}

model GongIntegration {
  id                   String       @id @default(cuid())
  organizationId       String       @unique

  // Encrypted API credentials (Basic Auth)
  accessKey            String       // Encrypted Gong Access Key
  accessKeySecret      String       // Encrypted Gong Access Key Secret

  // Sync state tracking
  lastSyncAt           DateTime?
  lastSyncStatus       String?      // 'success' | 'failed' | 'in_progress'
  lastSyncError        String?
  syncCursor           String?      // ISO datetime for incremental sync (fromDateTime)

  // Configuration
  isEnabled            Boolean      @default(true)
  syncIntervalMinutes  Int          @default(60)

  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([isEnabled])
  @@schema("opportunity_tracker")
}

model User {
  id                         String                      @id @default(cuid())
  email                      String                      @unique
  name                       String?
  avatarUrl                  String?
  createdAt                  DateTime                    @default(now())
  supabaseId                 String?                     @unique
  managerId                  String?
  organizationId             String?
  role                       UserRole                    @default(REP)
  annualQuota                Int?
  autoCreateMeetingTasks     Boolean                     @default(true)
  taskFilterPreference       String                      @default("today")
  ownedAccounts              Account[]                   @relation("AccountOwner")
  calendarEvents             CalendarEvent[]
  calendarSyncStates         CalendarSyncState[]
  chatMessages               ChatMessage[]
  authoredComments           Comment[]                   @relation("AuthoredComments")
  createdContents            Content[]                   @relation("ContentCreatedBy")
  createdDocuments           Document[]                  @relation("DocumentCreatedBy")
  editedDocuments            Document[]                  @relation("DocumentLastEditedBy")
  createdFrameworks          ContentFramework[]          @relation("FrameworkCreatedBy")
  generatedContents          GeneratedContent[]          @relation("GeneratedContentCreatedBy")
  resolvedComments           Comment[]                   @relation("ResolvedComments")
  mentions                   CommentMention[]            @relation("UserMentions")
  reactions                  CommentReaction[]           @relation("UserReactions")
  contactsReadyNotifications     ContactsReadyNotification[]     @relation("ContactsReadyNotifications")
  parsingCompleteNotifications   ParsingCompleteNotification[]   @relation("ParsingCompleteNotifications")
  accountResearchNotifications   AccountResearchNotification[]   @relation("AccountResearchNotifications")
  invitations                    Invitation[]
  kanbanViews                  KanbanView[]
  mapsLastEdited               MutualActionPlan[]          @relation("MAPLastEditedBy")
  oauthTokens                OAuthToken[]
  opportunities              Opportunity[]
  tasks                      Task[]
  taskLists                  TaskList[]
  manager                    User?                       @relation("ManagerReps", fields: [managerId], references: [id])
  directReports              User[]                      @relation("ManagerReps")
  organization               Organization?               @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([managerId])
  @@schema("opportunity_tracker")
}

model OAuthToken {
  id           String   @id @default(cuid())
  userId       String
  provider     String
  accessToken  String
  refreshToken String?
  expiresAt    DateTime
  scopes       String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@index([expiresAt])
  @@schema("opportunity_tracker")
}

model CalendarSyncState {
  id             String    @id @default(cuid())
  userId         String
  provider       String
  syncToken      String?
  timeMin        DateTime
  timeMax        DateTime
  lastSyncAt     DateTime?
  lastSyncStatus String?
  lastSyncError  String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@index([lastSyncAt])
  @@schema("opportunity_tracker")
}

model CalendarEvent {
  id             String              @id @default(cuid())
  userId         String
  googleEventId  String?
  source         CalendarEventSource @default(google)
  summary        String
  description    String?
  location       String?
  startTime      DateTime
  endTime        DateTime
  attendees      String[]
  isExternal     Boolean
  organizerEmail String?
  meetingUrl     String?
  opportunityId       String?
  accountId           String?
  followupTaskCreated Boolean?            @default(false)
  prepTaskCreated     Boolean?            @default(false)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  account        Account?            @relation(fields: [accountId], references: [id])
  gongCalls      GongCall[]
  granolaNotes   GranolaNote[]
  opportunity    Opportunity?        @relation(fields: [opportunityId], references: [id])
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, googleEventId])
  @@index([userId, startTime])
  @@index([opportunityId])
  @@index([accountId])
  @@index([source])
  @@index([accountId, startTime])
  @@index([opportunityId, startTime])
  @@index([userId, startTime, isExternal])
  @@schema("opportunity_tracker")
}

model TaskList {
  id           String   @id @default(cuid())
  userId       String
  googleListId String
  title        String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tasks        Task[]
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, googleListId])
  @@index([userId])
  @@schema("opportunity_tracker")
}

model Task {
  id            String       @id @default(cuid())
  userId        String
  taskListId    String
  googleTaskId  String
  title         String
  notes         String?
  due           DateTime?
  status        TaskStatus   @default(needsAction)
  position      String
  opportunityId String?
  accountId     String?
  taskSource    String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  completedAt   DateTime?
  account       Account?     @relation(fields: [accountId], references: [id])
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id])
  taskList      TaskList     @relation(fields: [taskListId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, googleTaskId])
  @@index([userId, status])
  @@index([opportunityId])
  @@index([accountId])
  @@index([taskListId])
  @@index([userId, taskSource])
  @@index([userId, status, due])
  // Note: Partial unique index Task_userId_taskSource_key created via raw SQL migration
  // Enforces uniqueness on (userId, taskSource) when taskSource IS NOT NULL
  // Allows multiple NULL values for manual tasks created via UI
  @@schema("opportunity_tracker")
}

model SecFiling {
  id                   String                  @id @default(cuid())
  accountId            String
  filingType           String
  filingDate           DateTime
  fiscalYear           Int?
  fiscalPeriod         String?
  accessionNumber      String
  filingUrl            String
  cik                  String
  primaryDocument      String?
  processingStatus     FilingProcessingStatus? @default(pending)
  processedAt          DateTime?
  processingError      String?
  businessOverview     String?
  riskFactors          Json?
  financialHighlights  Json?
  strategicInitiatives String?
  aiSummary            String?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  organizationId       String
  account              Account                 @relation(fields: [accountId], references: [id], onDelete: Cascade)
  organization         Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([accountId, accessionNumber])
  @@index([organizationId])
  @@index([accountId])
  @@index([processingStatus])
  @@index([filingDate])
  @@index([accountId, processingStatus, filingDate])
  @@schema("opportunity_tracker")
}

model EarningsCallTranscript {
  id                   String                      @id @default(cuid())
  accountId            String
  opportunityId        String?
  quarter              String
  fiscalYear           Int
  callDate             DateTime
  title                String
  source               String
  sourceUrl            String?
  transcriptText       String?
  processingStatus     TranscriptProcessingStatus? @default(pending)
  processedAt          DateTime?
  processingError      String?
  keyQuotes            Json?
  revenueGuidance      Json?
  productAnnouncements Json?
  competitiveLandscape String?
  executiveSentiment   String?
  aiSummary            String?
  createdAt            DateTime                    @default(now())
  updatedAt            DateTime                    @updatedAt
  organizationId       String
  account              Account                     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  opportunity          Opportunity?                @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  organization         Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([accountId, fiscalYear, quarter])
  @@index([organizationId])
  @@index([accountId])
  @@index([opportunityId])
  @@index([processingStatus])
  @@index([callDate])
  @@schema("opportunity_tracker")
}

model ChatMessage {
  id            String       @id @default(cuid())
  opportunityId String?
  accountId     String?
  userId        String
  role          String
  content       String
  contextSize   Int?
  createdAt     DateTime     @default(now())
  account       Account?     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([accountId])
  @@index([userId])
  @@index([createdAt])
  @@schema("opportunity_tracker")
}

model Comment {
  id             String            @id @default(cuid())
  content        String
  authorId       String
  organizationId String
  entityType     String
  entityId       String
  pageContext    String?
  selectionType  String?
  anchorSelector String?
  anchorOffset   Int?
  focusSelector  String?
  focusOffset    Int?
  selectedText   String?
  isResolved     Boolean           @default(false)
  resolvedAt     DateTime?
  resolvedById   String?
  parentId       String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  editedAt       DateTime?
  author         User              @relation("AuthoredComments", fields: [authorId], references: [id])
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent         Comment?          @relation("CommentReplies", fields: [parentId], references: [id])
  replies        Comment[]         @relation("CommentReplies")
  resolvedBy     User?             @relation("ResolvedComments", fields: [resolvedById], references: [id])
  mentions       CommentMention[]
  reactions      CommentReaction[]

  @@index([organizationId])
  @@index([authorId])
  @@index([entityType, entityId])
  @@index([parentId])
  @@index([isResolved])
  @@index([createdAt])
  @@index([entityType, entityId, isResolved, createdAt])
  @@index([organizationId, createdAt])
  @@schema("opportunity_tracker")
}

model CommentMention {
  id             String       @id @default(cuid())
  commentId      String
  userId         String
  organizationId String
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  comment        Comment      @relation(fields: [commentId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation("UserMentions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([userId, organizationId, isRead])
  @@index([userId])
  @@index([commentId])
  @@index([organizationId])
  @@index([isRead])
  @@index([userId, isRead, createdAt])
  @@schema("opportunity_tracker")
}

model CommentReaction {
  id        String   @id @default(cuid())
  commentId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation("UserReactions", fields: [userId], references: [id])

  @@unique([commentId, userId, emoji])
  @@index([commentId])
  @@index([userId])
  @@schema("opportunity_tracker")
}

model ContactsReadyNotification {
  id              String       @id @default(cuid())
  userId          String
  organizationId  String

  // Source of the contacts (one of these will be set)
  gongCallId      String?
  granolaNoteId   String?

  // Metadata
  contactCount    Int          // Number of contacts extracted
  opportunityId   String       // For navigation
  opportunityName String       // For display in notification
  callTitle       String       // Gong call or Granola note title

  // Status
  isRead          Boolean      @default(false)
  readAt          DateTime?
  createdAt       DateTime     @default(now())

  // Relations
  user            User         @relation("ContactsReadyNotifications", fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  gongCall        GongCall?    @relation(fields: [gongCallId], references: [id], onDelete: Cascade)
  granolaNote     GranolaNote? @relation(fields: [granolaNoteId], references: [id], onDelete: Cascade)
  opportunity     Opportunity  @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@unique([userId, gongCallId])      // One notification per user per Gong call
  @@unique([userId, granolaNoteId])   // One notification per user per Granola note
  @@index([userId, organizationId, isRead])
  @@index([userId, isRead, createdAt])
  @@schema("opportunity_tracker")
}

model ParsingCompleteNotification {
  id              String       @id @default(cuid())
  userId          String
  organizationId  String

  // Source (one will be set)
  gongCallId      String?
  granolaNoteId   String?

  // Metadata for display and navigation
  opportunityId   String
  opportunityName String
  callTitle       String

  // Status
  isRead          Boolean      @default(false)
  readAt          DateTime?
  createdAt       DateTime     @default(now())

  // Relations
  user            User         @relation("ParsingCompleteNotifications", fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  gongCall        GongCall?    @relation("GongCallParsingCompleteNotifications", fields: [gongCallId], references: [id], onDelete: Cascade)
  granolaNote     GranolaNote? @relation("GranolaParsingCompleteNotifications", fields: [granolaNoteId], references: [id], onDelete: Cascade)
  opportunity     Opportunity  @relation("OpportunityParsingCompleteNotifications", fields: [opportunityId], references: [id], onDelete: Cascade)

  @@unique([userId, gongCallId])
  @@unique([userId, granolaNoteId])
  @@index([userId, organizationId, isRead])
  @@index([userId, isRead, createdAt])
  @@schema("opportunity_tracker")
}

model AccountResearchNotification {
  id              String       @id @default(cuid())
  userId          String
  organizationId  String

  // Metadata for display and navigation
  opportunityId   String       @unique  // One notification per opportunity
  opportunityName String
  accountName     String

  // Status
  isRead          Boolean      @default(false)
  readAt          DateTime?
  createdAt       DateTime     @default(now())

  // Relations
  user            User         @relation("AccountResearchNotifications", fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  opportunity     Opportunity  @relation("OpportunityAccountResearchNotification", fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([userId, organizationId, isRead])
  @@index([userId, isRead, createdAt])
  @@schema("opportunity_tracker")
}

enum ContactRole {
  decision_maker
  influencer
  champion
  blocker
  end_user

  @@schema("opportunity_tracker")
}

enum ContactSentiment {
  advocate
  positive
  neutral
  negative
  unknown

  @@schema("opportunity_tracker")
}

enum ForecastCategory {
  pipeline
  bestCase
  commit
  closedWon
  closedLost

  @@schema("opportunity_tracker")
}

enum NoteType {
  customer
  internal
  prospect

  @@schema("opportunity_tracker")
}

enum OpportunityStage {
  discovery
  demo
  validateSolution
  decisionMakerApproval
  contracting
  closedWon
  closedLost

  @@schema("opportunity_tracker")
}

enum PlatformType {
  oem
  api
  isv

  @@schema("opportunity_tracker")
}

enum ReviewStatus {
  not_started
  in_progress
  complete
  not_applicable

  @@schema("opportunity_tracker")
}

enum UserRole {
  ADMIN
  MANAGER
  REP
  VIEWER

  @@schema("opportunity_tracker")
}

enum ViewType {
  custom
  quarterly
  stages
  forecast

  @@schema("opportunity_tracker")
}

enum AccountResearchStatus {
  generating
  completed
  failed

  @@schema("opportunity_tracker")
}

enum ParsingStatus {
  pending
  parsing
  completed
  failed

  @@schema("opportunity_tracker")
}

enum ConsolidationStatus {
  idle
  processing
  completed
  failed

  @@schema("opportunity_tracker")
}

enum NextCallDateSource {
  auto_calendar
  auto_gong
  auto_granola
  manual

  @@schema("opportunity_tracker")
}

enum FilingProcessingStatus {
  pending
  processing
  completed
  failed

  @@schema("opportunity_tracker")
}

enum TranscriptProcessingStatus {
  pending
  processing
  completed
  failed

  @@schema("opportunity_tracker")
}

enum TaskStatus {
  needsAction
  completed

  @@schema("opportunity_tracker")
}

enum CalendarEventSource {
  google
  manual

  @@schema("opportunity_tracker")
}

model SecCompanyCache {
  id        String   @id @default(cuid())
  cik       String   @unique
  ticker    String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([ticker])
  @@schema("opportunity_tracker")
}

model Content {
  id             String       @id @default(cuid())
  title          String
  url            String
  description    String?
  body           String?      @db.Text
  contentType    ContentType
  createdById    String
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  createdBy               User               @relation("ContentCreatedBy", fields: [createdById], references: [id])
  organization            Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  mapsUsingAsTemplate     MutualActionPlan[] @relation("MAPTemplateContent")

  @@unique([organizationId, url])
  @@index([organizationId])
  @@index([contentType])
  @@schema("opportunity_tracker")
}

enum ContentType {
  blog_post
  case_study
  whitepaper
  video
  webinar
  mutual_action_plan
  business_case
  customers
  other

  @@schema("opportunity_tracker")
}

model MutualActionPlan {
  id                String              @id @default(cuid())
  opportunityId     String              @unique
  version           Int                 @default(1)

  // Generation status
  generationStatus  MapGenerationStatus @default(pending)
  generatedAt       DateTime?
  generationError   String?

  // Content
  title             String?
  actionItems       Json                @default("[]")

  // Source tracking
  sourceCallCount   Int?
  templateContentId String?

  // User edits
  lastEditedById    String?
  lastEditedAt      DateTime?

  // Multi-tenant
  organizationId    String

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  opportunity       Opportunity         @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  organization      Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lastEditedBy      User?               @relation("MAPLastEditedBy", fields: [lastEditedById], references: [id])
  templateContent   Content?            @relation("MAPTemplateContent", fields: [templateContentId], references: [id])

  @@index([organizationId])
  @@index([opportunityId])
  @@index([generationStatus])
  @@schema("opportunity_tracker")
}

enum MapGenerationStatus {
  pending
  generating
  completed
  failed

  @@schema("opportunity_tracker")
}

enum FrameworkCategory {
  mutual_action_plan
  business_case
  proposal
  email
  account_plan
  executive_summary
  internal_prep_doc
  notes
  general
  other

  @@schema("opportunity_tracker")
}

enum FrameworkScope {
  company
  personal

  @@schema("opportunity_tracker")
}

enum ContentGenerationStatus {
  pending
  generating
  completed
  failed

  @@schema("opportunity_tracker")
}

enum DocumentType {
  mutual_action_plan  // Structured MAP with action items (JSON)
  rich_text           // Free-form rich text (markdown)
  framework_generated // AI-generated from ContentFramework

  @@schema("opportunity_tracker")
}

enum DocumentGenerationStatus {
  pending
  generating
  completed
  failed

  @@schema("opportunity_tracker")
}

model ContentFramework {
  id                String            @id @default(cuid())
  name              String
  description       String?
  category          FrameworkCategory
  scope             FrameworkScope
  systemInstruction String            @db.Text
  outputFormat      String?           @db.Text
  sections          Json              // Array<{ title: string, description?: string, required?: boolean }>
  contextConfig     Json?             // { meetings?: boolean, files?: boolean, notes?: boolean, accountResearch?: boolean }
  createdById       String
  organizationId    String
  isDefault         Boolean           @default(false)
  usageCount        Int               @default(0)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  createdBy         User              @relation("FrameworkCreatedBy", fields: [createdById], references: [id])
  organization      Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents         Document[]
  generatedContents GeneratedContent[]

  @@unique([organizationId, name, scope])
  @@index([organizationId])
  @@index([category])
  @@index([scope])
  @@index([createdById])
  @@schema("opportunity_tracker")
}

model GeneratedContent {
  id               String                  @id @default(cuid())
  frameworkId      String
  opportunityId    String
  title            String
  content          String                  @db.Text
  contextSnapshot  Json?                   // What context was used for generation
  version          Int                     @default(1)
  parentVersionId  String?                 // Link to previous version for history
  generationStatus ContentGenerationStatus @default(pending)
  generatedAt      DateTime?
  generationError  String?
  createdById      String
  organizationId   String
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt

  framework        ContentFramework        @relation(fields: [frameworkId], references: [id], onDelete: Cascade)
  opportunity      Opportunity             @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  parentVersion    GeneratedContent?       @relation("ContentVersions", fields: [parentVersionId], references: [id])
  childVersions    GeneratedContent[]      @relation("ContentVersions")
  createdBy        User                    @relation("GeneratedContentCreatedBy", fields: [createdById], references: [id])
  organization     Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([frameworkId])
  @@index([organizationId])
  @@index([createdById])
  @@index([opportunityId, frameworkId])
  @@index([generationStatus])
  @@schema("opportunity_tracker")
}

model Document {
  id                String                    @id @default(cuid())
  opportunityId     String
  organizationId    String

  // Core fields
  title             String
  documentType      DocumentType

  // Content - one of these will be populated based on type
  content           String?                   @db.Text   // Markdown for rich_text/framework_generated
  structuredData    Json?                     // For MAPs: { actionItems: [...] }

  // Framework reference (only for framework_generated)
  frameworkId       String?

  // Generation metadata
  generationStatus  DocumentGenerationStatus?
  generatedAt       DateTime?
  generationError   String?
  contextSnapshot   Json?                     // What context was used for generation

  // Versioning
  version           Int                       @default(1)
  parentVersionId   String?                   // Link to previous version for history

  // Audit
  createdById       String
  lastEditedById    String?
  lastEditedAt      DateTime?
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt

  // Relations
  opportunity       Opportunity               @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  organization      Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  framework         ContentFramework?         @relation(fields: [frameworkId], references: [id])
  createdBy         User                      @relation("DocumentCreatedBy", fields: [createdById], references: [id])
  lastEditedBy      User?                     @relation("DocumentLastEditedBy", fields: [lastEditedById], references: [id])
  parentVersion     Document?                 @relation("DocumentVersions", fields: [parentVersionId], references: [id])
  childVersions     Document[]                @relation("DocumentVersions")

  @@index([opportunityId])
  @@index([organizationId])
  @@index([documentType])
  @@index([frameworkId])
  @@index([opportunityId, documentType])
  @@index([createdById])
  @@schema("opportunity_tracker")
}
