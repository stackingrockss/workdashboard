generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["opportunity_tracker"]
}

model Account {
  id                  String                   @id @default(cuid())
  name                String
  industry            String?
  priority            String                   @default("medium")
  health              String                   @default("good")
  notes               String?
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  ownerId             String?
  organizationId      String
  website             String?
  ticker              String?
  nextEarningsDate    DateTime?
  earningsDateSource  String?
  lastEarningsSync    DateTime?
  organization        Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner               User?                    @relation("AccountOwner", fields: [ownerId], references: [id])
  calendarEvents      CalendarEvent[]
  chatMessages        ChatMessage[]
  contacts            Contact[]
  earningsTranscripts EarningsCallTranscript[]
  opportunities       Opportunity[]
  secFilings          SecFiling[]
  tasks               Task[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([ownerId])
  @@index([nextEarningsDate])
  @@schema("opportunity_tracker")
}

model Contact {
  id            String           @id @default(cuid())
  firstName     String
  lastName      String
  title         String?
  email         String?
  phone         String?
  role          ContactRole
  sentiment     ContactSentiment @default(unknown)
  opportunityId String?
  managerId     String?
  positionX     Float?
  positionY     Float?
  notes         String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  accountId     String?
  account       Account?         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  manager       Contact?         @relation("ContactReports", fields: [managerId], references: [id])
  directReports Contact[]        @relation("ContactReports")
  opportunity   Opportunity?     @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([accountId])
  @@schema("opportunity_tracker")
}

model GongCall {
  id              String         @id @default(cuid())
  opportunityId   String
  title           String
  url             String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  meetingDate     DateTime
  noteType        NoteType?      @default(customer)
  goals           Json?
  nextSteps       Json?
  painPoints      Json?
  parsedAt        DateTime?
  parsedPeople    Json?
  transcriptText  String?
  parsingError    String?
  parsingStatus   ParsingStatus?
  riskAssessment  Json?
  calendarEventId String?
  calendarEvent   CalendarEvent? @relation(fields: [calendarEventId], references: [id], onDelete: SetNull)
  opportunity     Opportunity    @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([parsingStatus])
  @@index([calendarEventId])
  @@schema("opportunity_tracker")
}

model GoogleNote {
  id            String      @id @default(cuid())
  opportunityId String
  title         String
  url           String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@schema("opportunity_tracker")
}

model GranolaNote {
  id              String         @id @default(cuid())
  opportunityId   String
  title           String
  url             String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  meetingDate     DateTime
  noteType        NoteType?      @default(customer)
  calendarEventId String?
  calendarEvent   CalendarEvent? @relation(fields: [calendarEventId], references: [id], onDelete: SetNull)
  opportunity     Opportunity    @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([calendarEventId])
  @@schema("opportunity_tracker")
}

model Invitation {
  id             String       @id @default(cuid())
  email          String
  role           UserRole     @default(REP)
  organizationId String
  invitedById    String
  token          String       @unique @default(cuid())
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime     @default(now())
  invitedBy      User         @relation(fields: [invitedById], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@schema("opportunity_tracker")
}

model KanbanColumn {
  id        String     @id @default(cuid())
  title     String
  order     Int
  color     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  viewId    String
  view      KanbanView @relation(fields: [viewId], references: [id], onDelete: Cascade)

  @@unique([viewId, order])
  @@schema("opportunity_tracker")
}

model KanbanView {
  id             String         @id @default(cuid())
  name           String
  viewType       ViewType
  isActive       Boolean        @default(false)
  isDefault      Boolean        @default(false)
  userId         String?
  organizationId String?
  lastAccessedAt DateTime?
  isShared       Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  columns        KanbanColumn[]
  organization   Organization?  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@unique([organizationId, name])
  @@index([userId, isActive])
  @@index([organizationId, isActive])
  @@schema("opportunity_tracker")
}

model Opportunity {
  id                         String                   @id @default(cuid())
  name                       String
  amountArr                  Int
  nextStep                   String?
  closeDate                  DateTime?
  stage                      OpportunityStage
  ownerId                    String
  createdAt                  DateTime                 @default(now())
  updatedAt                  DateTime                 @updatedAt
  accountId                  String?
  accountName                String?
  quarter                    String?
  forecastCategory           ForecastCategory?
  notes                      String?
  riskNotes                  String?
  columnId                   String?
  accountResearch            String?
  confidenceLevel            Int                      @default(3)
  decisionMakers             String?
  competition                String?
  legalReviewStatus          ReviewStatus?            @default(not_started)
  securityReviewStatus       ReviewStatus?            @default(not_started)
  platformType               PlatformType?
  businessCaseStatus         ReviewStatus?            @default(not_started)
  organizationId             String
  pinnedToWhiteboard         Boolean                  @default(false)
  accountResearchStatus      AccountResearchStatus?
  accountResearchGeneratedAt DateTime?
  goalsHistory               String?
  nextStepsHistory           String?
  painPointsHistory          String?
  parsedGongCallIds          String[]                 @default([])
  consolidatedGoals          Json?
  consolidatedPainPoints     Json?
  consolidatedRiskAssessment Json?
  consolidationCallCount     Int?
  lastConsolidatedAt         DateTime?
  consolidationStatus        ConsolidationStatus?     @default(idle)
  cbc                        DateTime?
  calendarEvents             CalendarEvent[]
  chatMessages               ChatMessage[]
  contacts                   Contact[]
  earningsTranscripts        EarningsCallTranscript[]
  gongCalls                  GongCall[]
  googleNotes                GoogleNote[]
  granolaNotes               GranolaNote[]
  account                    Account?                 @relation(fields: [accountId], references: [id])
  organization               Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner                      User                     @relation(fields: [ownerId], references: [id])
  tasks                      Task[]

  @@index([organizationId])
  @@index([ownerId])
  @@index([accountId])
  @@index([columnId])
  @@index([closeDate])
  @@index([pinnedToWhiteboard])
  @@schema("opportunity_tracker")
}

model Organization {
  id                   String                   @id @default(cuid())
  name                 String
  domain               String?                  @unique
  logo                 String?
  fiscalYearStartMonth Int                      @default(1)
  createdAt            DateTime                 @default(now())
  updatedAt            DateTime                 @updatedAt
  accounts             Account[]
  comments             Comment[]
  commentMentions      CommentMention[]
  contents             Content[]
  earningsTranscripts  EarningsCallTranscript[]
  invitations          Invitation[]
  kanbanViews          KanbanView[]
  opportunities        Opportunity[]
  settings             OrganizationSettings?
  secFilings           SecFiling[]
  users                User[]

  @@schema("opportunity_tracker")
}

model OrganizationSettings {
  id                      String       @id @default(cuid())
  organizationId          String       @unique
  defaultKanbanView       String?
  defaultKanbanTemplateId String?
  allowSelfSignup         Boolean      @default(false)
  allowDomainAutoJoin     Boolean      @default(false)
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt
  organization            Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@schema("opportunity_tracker")
}

model User {
  id                 String               @id @default(cuid())
  email              String               @unique
  name               String?
  avatarUrl          String?
  createdAt          DateTime             @default(now())
  supabaseId         String?              @unique
  managerId          String?
  organizationId     String?
  role               UserRole             @default(REP)
  annualQuota        Int?
  ownedAccounts      Account[]            @relation("AccountOwner")
  calendarEvents     CalendarEvent[]
  calendarSyncStates CalendarSyncState[]
  chatMessages       ChatMessage[]
  authoredComments   Comment[]            @relation("AuthoredComments")
  createdContents    Content[]            @relation("ContentCreatedBy")
  resolvedComments   Comment[]            @relation("ResolvedComments")
  mentions           CommentMention[]     @relation("UserMentions")
  reactions          CommentReaction[]    @relation("UserReactions")
  invitations        Invitation[]
  kanbanViews        KanbanView[]
  oauthTokens        OAuthToken[]
  opportunities      Opportunity[]
  tasks              Task[]
  taskLists          TaskList[]
  manager            User?                @relation("ManagerReps", fields: [managerId], references: [id])
  directReports      User[]               @relation("ManagerReps")
  organization       Organization?        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([managerId])
  @@schema("opportunity_tracker")
}

model OAuthToken {
  id           String   @id @default(cuid())
  userId       String
  provider     String
  accessToken  String
  refreshToken String?
  expiresAt    DateTime
  scopes       String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@index([expiresAt])
  @@schema("opportunity_tracker")
}

model CalendarSyncState {
  id             String    @id @default(cuid())
  userId         String
  provider       String
  syncToken      String?
  timeMin        DateTime
  timeMax        DateTime
  lastSyncAt     DateTime?
  lastSyncStatus String?
  lastSyncError  String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@index([userId])
  @@index([lastSyncAt])
  @@schema("opportunity_tracker")
}

model CalendarEvent {
  id             String              @id @default(cuid())
  userId         String
  googleEventId  String?
  source         CalendarEventSource @default(google)
  summary        String
  description    String?
  location       String?
  startTime      DateTime
  endTime        DateTime
  attendees      String[]
  isExternal     Boolean
  organizerEmail String?
  meetingUrl     String?
  opportunityId  String?
  accountId      String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  account        Account?            @relation(fields: [accountId], references: [id])
  gongCalls      GongCall[]
  granolaNotes   GranolaNote[]
  opportunity    Opportunity?        @relation(fields: [opportunityId], references: [id])
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, googleEventId])
  @@index([userId, startTime])
  @@index([opportunityId])
  @@index([accountId])
  @@index([source])
  @@schema("opportunity_tracker")
}

model TaskList {
  id           String   @id @default(cuid())
  userId       String
  googleListId String
  title        String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tasks        Task[]
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, googleListId])
  @@index([userId])
  @@schema("opportunity_tracker")
}

model Task {
  id            String       @id @default(cuid())
  userId        String
  taskListId    String
  googleTaskId  String
  title         String
  notes         String?
  due           DateTime?
  status        TaskStatus   @default(needsAction)
  position      String
  opportunityId String?
  accountId     String?
  taskSource    String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  completedAt   DateTime?
  account       Account?     @relation(fields: [accountId], references: [id])
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id])
  taskList      TaskList     @relation(fields: [taskListId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, googleTaskId])
  @@index([userId, status])
  @@index([opportunityId])
  @@index([accountId])
  @@index([taskListId])
  @@schema("opportunity_tracker")
}

model SecFiling {
  id                   String                  @id @default(cuid())
  accountId            String
  filingType           String
  filingDate           DateTime
  fiscalYear           Int?
  fiscalPeriod         String?
  accessionNumber      String
  filingUrl            String
  cik                  String
  primaryDocument      String?
  processingStatus     FilingProcessingStatus? @default(pending)
  processedAt          DateTime?
  processingError      String?
  businessOverview     String?
  riskFactors          Json?
  financialHighlights  Json?
  strategicInitiatives String?
  aiSummary            String?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  organizationId       String
  account              Account                 @relation(fields: [accountId], references: [id], onDelete: Cascade)
  organization         Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([accountId, accessionNumber])
  @@index([organizationId])
  @@index([accountId])
  @@index([processingStatus])
  @@index([filingDate])
  @@schema("opportunity_tracker")
}

model EarningsCallTranscript {
  id                   String                      @id @default(cuid())
  accountId            String
  opportunityId        String?
  quarter              String
  fiscalYear           Int
  callDate             DateTime
  title                String
  source               String
  sourceUrl            String?
  transcriptText       String?
  processingStatus     TranscriptProcessingStatus? @default(pending)
  processedAt          DateTime?
  processingError      String?
  keyQuotes            Json?
  revenueGuidance      Json?
  productAnnouncements Json?
  competitiveLandscape String?
  executiveSentiment   String?
  aiSummary            String?
  createdAt            DateTime                    @default(now())
  updatedAt            DateTime                    @updatedAt
  organizationId       String
  account              Account                     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  opportunity          Opportunity?                @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  organization         Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([accountId, fiscalYear, quarter])
  @@index([organizationId])
  @@index([accountId])
  @@index([opportunityId])
  @@index([processingStatus])
  @@index([callDate])
  @@schema("opportunity_tracker")
}

model ChatMessage {
  id            String       @id @default(cuid())
  opportunityId String?
  accountId     String?
  userId        String
  role          String
  content       String
  contextSize   Int?
  createdAt     DateTime     @default(now())
  account       Account?     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([opportunityId])
  @@index([accountId])
  @@index([userId])
  @@index([createdAt])
  @@schema("opportunity_tracker")
}

model Comment {
  id             String            @id @default(cuid())
  content        String
  authorId       String
  organizationId String
  entityType     String
  entityId       String
  pageContext    String?
  selectionType  String?
  anchorSelector String?
  anchorOffset   Int?
  focusSelector  String?
  focusOffset    Int?
  selectedText   String?
  isResolved     Boolean           @default(false)
  resolvedAt     DateTime?
  resolvedById   String?
  parentId       String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  editedAt       DateTime?
  author         User              @relation("AuthoredComments", fields: [authorId], references: [id])
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parent         Comment?          @relation("CommentReplies", fields: [parentId], references: [id])
  replies        Comment[]         @relation("CommentReplies")
  resolvedBy     User?             @relation("ResolvedComments", fields: [resolvedById], references: [id])
  mentions       CommentMention[]
  reactions      CommentReaction[]

  @@index([organizationId])
  @@index([authorId])
  @@index([entityType, entityId])
  @@index([parentId])
  @@index([isResolved])
  @@index([createdAt])
  @@schema("opportunity_tracker")
}

model CommentMention {
  id             String       @id @default(cuid())
  commentId      String
  userId         String
  organizationId String
  isRead         Boolean      @default(false)
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  comment        Comment      @relation(fields: [commentId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation("UserMentions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([userId, organizationId, isRead])
  @@index([userId])
  @@index([commentId])
  @@index([organizationId])
  @@index([isRead])
  @@schema("opportunity_tracker")
}

model CommentReaction {
  id        String   @id @default(cuid())
  commentId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation("UserReactions", fields: [userId], references: [id])

  @@unique([commentId, userId, emoji])
  @@index([commentId])
  @@index([userId])
  @@schema("opportunity_tracker")
}

enum ContactRole {
  decision_maker
  influencer
  champion
  blocker
  end_user

  @@schema("opportunity_tracker")
}

enum ContactSentiment {
  advocate
  positive
  neutral
  negative
  unknown

  @@schema("opportunity_tracker")
}

enum ForecastCategory {
  pipeline
  bestCase
  commit
  closedWon
  closedLost

  @@schema("opportunity_tracker")
}

enum NoteType {
  customer
  internal
  prospect

  @@schema("opportunity_tracker")
}

enum OpportunityStage {
  discovery
  demo
  validateSolution
  decisionMakerApproval
  contracting
  closedWon
  closedLost

  @@schema("opportunity_tracker")
}

enum PlatformType {
  oem
  api
  isv

  @@schema("opportunity_tracker")
}

enum ReviewStatus {
  not_started
  in_progress
  complete
  not_applicable

  @@schema("opportunity_tracker")
}

enum UserRole {
  ADMIN
  MANAGER
  REP
  VIEWER

  @@schema("opportunity_tracker")
}

enum ViewType {
  custom
  quarterly
  stages
  forecast

  @@schema("opportunity_tracker")
}

enum AccountResearchStatus {
  generating
  completed
  failed

  @@schema("opportunity_tracker")
}

enum ParsingStatus {
  pending
  parsing
  completed
  failed

  @@schema("opportunity_tracker")
}

enum ConsolidationStatus {
  idle
  processing
  completed
  failed

  @@schema("opportunity_tracker")
}

enum FilingProcessingStatus {
  pending
  processing
  completed
  failed

  @@schema("opportunity_tracker")
}

enum TranscriptProcessingStatus {
  pending
  processing
  completed
  failed

  @@schema("opportunity_tracker")
}

enum TaskStatus {
  needsAction
  completed

  @@schema("opportunity_tracker")
}

enum CalendarEventSource {
  google
  manual

  @@schema("opportunity_tracker")
}

model SecCompanyCache {
  id        String   @id @default(cuid())
  cik       String   @unique
  ticker    String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([ticker])
  @@schema("opportunity_tracker")
}

model Content {
  id             String       @id @default(cuid())
  title          String
  url            String
  description    String?
  contentType    ContentType
  createdById    String
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  createdBy      User         @relation("ContentCreatedBy", fields: [createdById], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, url])
  @@index([organizationId])
  @@index([contentType])
  @@schema("opportunity_tracker")
}

enum ContentType {
  blog_post
  case_study
  whitepaper
  video
  webinar
  other

  @@schema("opportunity_tracker")
}
