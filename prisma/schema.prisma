// Prisma schema for Opportunity Tracker
// Last updated: 2025-10-11

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["opportunity_tracker"]
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  name          String
  avatarUrl     String?
  opportunities Opportunity[]
  kanbanColumns KanbanColumn[]
  createdAt     DateTime       @default(now())

  @@schema("opportunity_tracker")
}

enum OpportunityStage {
  prospect
  qualification
  proposal
  negotiation
  closedWon
  closedLost

  @@schema("opportunity_tracker")
}

enum ForecastCategory {
  pipeline
  bestCase
  forecast

  @@schema("opportunity_tracker")
}

model Account {
  id            String         @id @default(cuid())
  name          String         @unique
  industry      String?
  priority      String         @default("medium") // low, medium, high
  health        String         @default("good") // good, at-risk, critical
  notes         String?
  opportunities Opportunity[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@schema("opportunity_tracker")
}

model KanbanColumn {
  id        String   @id @default(cuid())
  title     String
  order     Int
  color     String?  // Optional hex color for the column header
  userId    String?  // Optional: per-user columns, null for global columns
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, order])
  @@schema("opportunity_tracker")
}

model Opportunity {
  id               String             @id @default(cuid())
  name             String
  // Keep old account field for backward compatibility during migration
  accountName      String?
  // New relation to Account model
  accountId        String?
  account          Account?           @relation(fields: [accountId], references: [id])
  amountArr        Int
  probability      Int
  nextStep         String?
  closeDate        DateTime?
  quarter          String?            // e.g., "Q1 2025", "Q2 2025"
  stage            OpportunityStage
  // New flexible column assignment
  columnId         String?            // References KanbanColumn.id
  forecastCategory ForecastCategory?
  riskNotes        String?
  notes            String?
  ownerId          String
  owner            User               @relation(fields: [ownerId], references: [id])
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  @@schema("opportunity_tracker")
}


