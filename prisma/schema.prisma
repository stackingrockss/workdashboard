generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["opportunity_tracker"]
}

model User {
  id              String           @id @default(cuid())
  email           String           @unique
  name            String
  avatarUrl       String?
  createdAt       DateTime         @default(now())
  supabaseId      String?          @unique
  kanbanColumns   KanbanColumn[]
  opportunities   Opportunity[]
  companySettings CompanySettings?

  @@schema("opportunity_tracker")
}

model Account {
  id            String        @id @default(cuid())
  name          String        @unique
  industry      String?
  priority      String        @default("medium")
  health        String        @default("good")
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  opportunities Opportunity[]
  contacts      Contact[]

  @@schema("opportunity_tracker")
}

model KanbanColumn {
  id        String   @id @default(cuid())
  title     String
  order     Int
  color     String?
  userId    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])

  @@unique([userId, order])
  @@schema("opportunity_tracker")
}

model Opportunity {
  id                   String            @id @default(cuid())
  name                 String
  amountArr            Int
  confidenceLevel      Int               @default(3) // 1-5 scale (replaces probability)
  nextStep             String?
  closeDate            DateTime?
  stage                OpportunityStage
  ownerId              String
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  accountId            String?
  accountName          String?
  quarter              String?
  forecastCategory     ForecastCategory?
  notes                String?
  riskNotes            String?
  accountResearch      String?
  columnId             String?
  // New fields from CSV
  decisionMakers       String?
  competition          String?
  legalReviewStatus    ReviewStatus?     @default(not_started)
  securityReviewStatus ReviewStatus?     @default(not_started)
  platformType         PlatformType?
  businessCaseStatus   ReviewStatus?     @default(not_started)
  contacts             Contact[]
  gongCalls            GongCall[]
  googleNotes          GoogleNote[]
  granolaNotes         GranolaNote[]
  account              Account?          @relation(fields: [accountId], references: [id])
  owner                User              @relation(fields: [ownerId], references: [id])

  @@schema("opportunity_tracker")
}

model GranolaNote {
  id            String      @id @default(cuid())
  opportunityId String
  title         String
  url           String
  meetingDate   DateTime
  noteType      NoteType    @default(customer)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@schema("opportunity_tracker")
}

model GongCall {
  id            String      @id @default(cuid())
  opportunityId String
  title         String
  url           String
  meetingDate   DateTime
  noteType      NoteType    @default(customer)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@schema("opportunity_tracker")
}

model GoogleNote {
  id            String      @id @default(cuid())
  opportunityId String
  title         String
  url           String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@schema("opportunity_tracker")
}

model Contact {
  id            String           @id @default(cuid())
  firstName     String
  lastName      String
  title         String?
  email         String?
  phone         String?
  role          ContactRole
  sentiment     ContactSentiment @default(unknown)
  opportunityId String?
  accountId     String?
  managerId     String?
  positionX     Float?
  positionY     Float?
  notes         String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  manager       Contact?         @relation("ContactReports", fields: [managerId], references: [id])
  directReports Contact[]        @relation("ContactReports")
  opportunity   Opportunity?     @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  account       Account?         @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@schema("opportunity_tracker")
}

enum OpportunityStage {
  discovery
  demo
  validateSolution
  decisionMakerApproval
  contracting
  closedWon
  closedLost

  @@schema("opportunity_tracker")
}

enum ForecastCategory {
  pipeline
  bestCase
  forecast

  @@schema("opportunity_tracker")
}

enum ContactRole {
  decision_maker
  influencer
  champion
  blocker
  end_user

  @@schema("opportunity_tracker")
}

enum ContactSentiment {
  advocate
  positive
  neutral
  negative
  unknown

  @@schema("opportunity_tracker")
}

enum ReviewStatus {
  not_started
  in_progress
  complete
  not_applicable

  @@schema("opportunity_tracker")
}

enum PlatformType {
  oem
  api
  isv

  @@schema("opportunity_tracker")
}

enum NoteType {
  customer
  internal

  @@schema("opportunity_tracker")
}

model CompanySettings {
  id                   String   @id @default(cuid())
  userId               String   @unique
  companyName          String?
  companyWebsite       String?
  fiscalYearStartMonth Int      @default(1)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("opportunity_tracker")
}
